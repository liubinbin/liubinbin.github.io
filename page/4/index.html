<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>BIN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="BIN">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="BIN">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="binbin liu">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="BIN" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">BIN</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">a blog of bin</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-jdb-usage" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/13/jdb-usage/" class="article-date">
  <time class="dt-published" datetime="2019-10-13T14:19:34.000Z" itemprop="datePublished">2019-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/13/jdb-usage/">jdb-usage</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在 java 进程有一些莫名其妙的问题，可以通过 jdb 来处理问题。</p>
<p>在上周在通过 HttpClient 访问时，有发现代码里的 NPE，从源码日志看逻辑是没有问题，运行的进程的 jar 包又不好替换，就使用 jdb 命令发现 getContentLength 方法返回值为 -1（后来发现另一个可以使用的接口里没有判断这个值，并且这个值也为 -1，我猜想是从 stream中获取导致不需要这个值），会导致 NPE。在这种情况下使用 jdb 命令非常方便的看到是怎么回事。</p>
<p>具体使用方法有两个博客可以参考，这里记录一下：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/joy-jdb/index.html">https://www.ibm.com/developerworks/cn/java/joy-jdb/index.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/arkblue/article/details/39718947">https://blog.csdn.net/arkblue/article/details/39718947</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/13/jdb-usage/" data-id="cm3sqo3lp0018h460f5hfckyf" data-title="jdb-usage" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-just-pick-the-first-one-from-todolist-and-finish-that" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/09/22/just-pick-the-first-one-from-todolist-and-finish-that/" class="article-date">
  <time class="dt-published" datetime="2019-09-22T12:53:33.000Z" itemprop="datePublished">2019-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/09/22/just-pick-the-first-one-from-todolist-and-finish-that/">just-pick-the-first-one-from-todolist-and-finish-that</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一件件的完成手头上的事"><a href="#一件件的完成手头上的事" class="headerlink" title="一件件的完成手头上的事"></a>一件件的完成手头上的事</h2><p>最近确实有些忙，渐渐的发现一个不然自己显得慌忙的方式：一件件的完成手头上的事。这话咋看起来是觉得比较莫名其妙。</p>
<p>这几天偶然看到好几年前自己的QQ签名，“当你犹豫不决，不知道应该先做好什么事情的时候，就静下心来，去做手头最近的事情。犹豫和切换事最浪费时间的事情”。</p>
<p>所以，最近开始疯狂的依赖便签，工作时间只从便签的第一个开始做，当然有时候会改变便签内事情的顺序。如果在做这件事的过程中，又插入一个件事，那就把它插入到便签里，这时候可能会考虑一下它到底在哪个顺位上。这么做了之后，发现两个效果：</p>
<ol>
<li>不会出现该干什么事情好的时候，应该任何时候就去做第一件事情就可以了。</li>
<li>单把项从便签中删除时，会有比较高的成就感，会更有动力去做下一件事情。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/09/22/just-pick-the-first-one-from-todolist-and-finish-that/" data-id="cm3sqo3lq001dh460hpdoe3bl" data-title="just-pick-the-first-one-from-todolist-and-finish-that" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/life/" rel="tag">life</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-timezone-in-spring-mybatis-mysql" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/09/22/timezone-in-spring-mybatis-mysql/" class="article-date">
  <time class="dt-published" datetime="2019-09-22T12:07:10.000Z" itemprop="datePublished">2019-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/09/22/timezone-in-spring-mybatis-mysql/">timezone-in-spring-mybatis-mysql</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="spring，mybatis-和-mysql-里的时区问题"><a href="#spring，mybatis-和-mysql-里的时区问题" class="headerlink" title="spring，mybatis 和 mysql 里的时区问题"></a>spring，mybatis 和 mysql 里的时区问题</h1><h2 id="大概路径"><a href="#大概路径" class="headerlink" title="大概路径"></a>大概路径</h2><p>客户端发起请求</p>
<ol>
<li>前端请求</li>
<li>spring 服务端</li>
<li>mybatis 访问</li>
<li>mysql 数据</li>
<li>spring 服务端</li>
<li>前端显示</li>
</ol>
<h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><p>通过命令 show variables like “%time_zone%”;  可以获取 mysql 的时区。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h2 id="mybatis"><a href="#mybatis" class="headerlink" title="mybatis"></a>mybatis</h2><p>在 spring.datasource.url 参数中需要制定 serverTimezone 和数据库应该对应起来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serverTimezone=GMT%2b8</span><br></pre></td></tr></table></figure>

<h2 id="spring"><a href="#spring" class="headerlink" title="spring"></a>spring</h2><p>可以通过如下代码获取时区</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TimeZone.getDefault()</span><br></pre></td></tr></table></figure>

<p>如果数据为 Date 类型我们可以在服务打印对应的数据来查看数据是否是对的（当然需要考虑时区）。</p>
<p>在对外显示时，我们需要 spring.jackson.time-zone 参数。比如我们如下制定东八区的话就可以看到Date类型被显示成 2019-09-23T00:32:12.000+0800。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.jackson.time-zone=GMT+8</span><br></pre></td></tr></table></figure>

<h2 id="序列化和反序列化"><a href="#序列化和反序列化" class="headerlink" title="序列化和反序列化"></a>序列化和反序列化</h2><p>###反序列化</p>
<p>如果在 query （ 前端传给服务端 ）中，默认格式是奇葩的 yyyy-MM-dd’T’HH:mm:ss.SSSZ 格式。一般情况我们会使用到 yyyy-MM-dd HH:mm:ss ，这时候我们需要自定义反序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonDeserialize(using = CustomJsonDateDeserializer.class)</span></span><br><span class="line"><span class="keyword">private</span> Date operateStartDate;</span><br></pre></td></tr></table></figure>

<p>反序列化类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomJsonDateDeserializer</span> <span class="keyword">extends</span> <span class="title class_">JsonDeserializer</span>&lt;Date&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">deserialize</span><span class="params">(JsonParser jp, DeserializationContext ctxt)</span> <span class="keyword">throws</span> IOException, JsonProcessingException &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">format</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> jp.getText();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> format.parse(date);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><p>如果在 dto （服务器端传给前端）中，默认的格式是奇葩的 2019-09-22T16:32:28.000+0800。一般情况下我们会使用到 yyyy-MM-dd HH:mm:ss ，这时候我们需要自定义序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonSerialize(using = CustomJsonDateSerializer.class)</span></span><br><span class="line"><span class="keyword">private</span> Date create_time;</span><br></pre></td></tr></table></figure>

<p>序列化类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomJsonDateSerializer</span> <span class="keyword">extends</span> <span class="title class_">JsonSerializer</span>&lt;Date&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Date date, JsonGenerator jsonGenerator, SerializerProvider serializerProvider)</span> <span class="keyword">throws</span> IOException, JsonProcessingException &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">dateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">dateString</span> <span class="operator">=</span> dateFormat.format(date);</span><br><span class="line">            jsonGenerator.writeString(dateString);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="多时区"><a href="#多时区" class="headerlink" title="多时区"></a>多时区</h2><p>如果是多时区，应该使用 UTC 进行存储，然后在显示的地方（前端）转换到各种地方对应的时区。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/09/22/timezone-in-spring-mybatis-mysql/" data-id="cm3sqo3lr0022h46069u0gaoz" data-title="timezone-in-spring-mybatis-mysql" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spring/" rel="tag">spring</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-some-thoughts-about-recent-internal-job-transfer" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/09/01/some-thoughts-about-recent-internal-job-transfer/" class="article-date">
  <time class="dt-published" datetime="2019-09-01T08:21:50.000Z" itemprop="datePublished">2019-09-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/09/01/some-thoughts-about-recent-internal-job-transfer/">some-thoughts-about-recent-internal-job-transfer</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="最近公司内部转岗"><a href="#最近公司内部转岗" class="headerlink" title="最近公司内部转岗"></a>最近公司内部转岗</h1><p>最近做了一个比较大的转折，公司内部转岗到别的部门。工作内容也从原来的大数据转到了目前的业务系统。主要思考如下：</p>
<ol>
<li>之前维护的服务比较稳定，并且可以预测到业务的发展并不需要我去做作很多事情。</li>
<li>工作了五年，确实需要在业务或更深的技术上做选择了。</li>
</ol>
<p>刚好公司给了一个内部转岗到一个做 2B 业务的部门的机会，所以想先去试试，看看做业务的感觉之后再决定。</p>
<p>目前对 2B 业务的感受：</p>
<ol>
<li>从质量包括应该是整体设计和关键技术点上去把控项目完成质量。所以看一个项目应该从更宏观的角度看，而不能过多的纠结与细节。</li>
<li>通过几轮测试和代码 review 去保证细节实现。类似的业务应该去提炼相似的内容然后脚本化，比如生成测试数据。</li>
</ol>
<p>感觉现在对未来还是比较焦虑，也不知道很多年后回头看这种焦虑是否是对的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/09/01/some-thoughts-about-recent-internal-job-transfer/" data-id="cm3sqo3lr001zh4603orsahgc" data-title="some-thoughts-about-recent-internal-job-transfer" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/job/" rel="tag">job</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-jdk-src-treemap" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/08/05/jdk-src-treemap/" class="article-date">
  <time class="dt-published" datetime="2019-08-05T15:50:40.000Z" itemprop="datePublished">2019-08-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/08/05/jdk-src-treemap/">jdk-src-treemap</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>wiki: <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BA%A2%E9%BB%91%E6%A0%91">https://zh.wikipedia.org/wiki/%E7%BA%A2%E9%BB%91%E6%A0%91</a></p>
<h2 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h2><pre><code>static final class Entry&lt;K, V&gt; implements Map.Entry&lt;K, V&gt; &#123;
    K key;
    V value;
    Entry&lt;K, V&gt; left;
    Entry&lt;K, V&gt; right;
    Entry&lt;K, V&gt; parent;
    boolean color = BLACK;
    ...
&#125;
</code></pre>
<p>Entry 成员变量有 key，value，左子节点，右子节点和颜色（默认为黑色）。</p>
<h2 id="查看源码小窍门"><a href="#查看源码小窍门" class="headerlink" title="查看源码小窍门"></a>查看源码小窍门</h2><p>由于 TreeMap 的代码比较干净和独立，我从源码包 src.zip 中拷贝出 TreeMap.java 重命名加入自己的工程内。就你可以对源码直接编辑了。</p>
<h2 id="核心思想"><a href="#核心思想" class="headerlink" title="核心思想"></a>核心思想</h2><ul>
<li>把红节点往上推或者往另一个子树推。</li>
</ul>
<h2 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h2><p>public V put(K key, V value) ：</p>
<ol>
<li><p>如果 root 为空，则先设置 root。</p>
</li>
<li><p>不停的按树的结构寻找需要放 key 的 Entry。</p>
<p>2.1 如果数中有对应 key 的 Entry，直接设置并返回。</p>
<p>2.2 如果没有，则找到 key 对应的 parent。</p>
</li>
<li><p>新建 key 和 value 的 Entry，加入到 parent 的子树中。</p>
</li>
<li><p>执行 fixAfterInsertion。</p>
</li>
<li><p>设置 size 和 modCount 值。</p>
</li>
</ol>
<p>fixAfterInsertion代码解读注释如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fixAfterInsertion</span><span class="params">(Entry&lt;K, V&gt; x)</span> &#123;</span><br><span class="line">	x.color = RED;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (x != <span class="literal">null</span> &amp;&amp; x != root &amp;&amp; x.parent.color == RED) &#123;</span><br><span class="line">		<span class="comment">// 如果是父节点是黑色的话，则不会改变红黑树性质，不做调整。如果父节点则说明无法满足性质，需要调整。</span></span><br><span class="line">		<span class="keyword">if</span> (parentOf(x) == leftOf(parentOf(parentOf(x)))) &#123;</span><br><span class="line">			<span class="comment">// 父节点是祖父节点做子节点。else里和此对应。</span></span><br><span class="line">			<span class="comment">// 获取叔父节点</span></span><br><span class="line">			Entry&lt;K, V&gt; y = rightOf(parentOf(parentOf(x)));</span><br><span class="line">			<span class="keyword">if</span> (colorOf(y) == RED) &#123;</span><br><span class="line">				<span class="comment">// 情形3</span></span><br><span class="line">				setColor(parentOf(x), BLACK);</span><br><span class="line">				setColor(y, BLACK);</span><br><span class="line">				setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">				x = parentOf(parentOf(x));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (x == rightOf(parentOf(x))) &#123;</span><br><span class="line">					<span class="comment">// 情形4（此情形是为5服务的）</span></span><br><span class="line">					x = parentOf(x);</span><br><span class="line">					<span class="comment">// 左旋</span></span><br><span class="line">					rotateLeft(x);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// 情形5，</span></span><br><span class="line">				setColor(parentOf(x), BLACK);</span><br><span class="line">				setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">				<span class="comment">// 右旋，右旋的意义在于不改变平衡树和红黑树性质的情况下，把一个红色转移到另一子树中。应为子树不会影响性质。</span></span><br><span class="line">				rotateRight(parentOf(parentOf(x)));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 与if内容类似，只是更改了左右方向。</span></span><br><span class="line">			Entry&lt;K, V&gt; y = leftOf(parentOf(parentOf(x)));</span><br><span class="line">			<span class="keyword">if</span> (colorOf(y) == RED) &#123;</span><br><span class="line">				setColor(parentOf(x), BLACK);</span><br><span class="line">				setColor(y, BLACK);</span><br><span class="line">				setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">				x = parentOf(parentOf(x));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (x == leftOf(parentOf(x))) &#123;</span><br><span class="line">					x = parentOf(x);</span><br><span class="line">					rotateRight(x);</span><br><span class="line">				&#125;</span><br><span class="line">				setColor(parentOf(x), BLACK);</span><br><span class="line">				setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">				rotateLeft(parentOf(parentOf(x)));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	root.color = BLACK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="读取数据"><a href="#读取数据" class="headerlink" title="读取数据"></a>读取数据</h2><p>和二叉树的搜索一样，根据大小的比较不停的往左子树和右子树搜索。知道找到对应的值或到叶子节点。</p>
<h2 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h2><p>删除逻辑的思路其实比较清晰，就是一步步去构造情形6，因为6可以通过旋转达到我们改变路径中黑色节点的个数。</p>
<p>deleteEntry代码解读注释如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteEntry</span><span class="params">(Entry&lt;K, V&gt; p)</span> &#123;</span><br><span class="line">	modCount++;</span><br><span class="line">	size--;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If strictly internal, copy successor&#x27;s element to p and then make p</span></span><br><span class="line">	<span class="comment">// point to successor.</span></span><br><span class="line">	<span class="comment">// 如果有两个子节点，则获取后继，然后将后继的节点的内容拷贝至p中，接下来要处理的就变成后继节点。</span></span><br><span class="line">	<span class="keyword">if</span> (p.left != <span class="literal">null</span> &amp;&amp; p.right != <span class="literal">null</span>) &#123;</span><br><span class="line">		Entry&lt;K, V&gt; s = successor(p);</span><br><span class="line">		p.key = s.key;</span><br><span class="line">		p.value = s.value;</span><br><span class="line">		p = s;</span><br><span class="line">	&#125; <span class="comment">// p has 2 children</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start fixup at replacement node, if it exists.</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 *  在这个时候我们可以保证的是，p节点最多只有一个子节点。分为三种情况。</span></span><br><span class="line"><span class="comment">	 *  1. 有一个节点</span></span><br><span class="line"><span class="comment">	 *  2. 此节点为ROOT</span></span><br><span class="line"><span class="comment">	 *  3. 没有子节点</span></span><br><span class="line"><span class="comment">	 *  此外，我们需要做当节点是黑色时 ，我们需要进行旋转，因为删除黑色会改变红黑树的性质。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	</span><br><span class="line">	Entry&lt;K, V&gt; replacement = (p.left != <span class="literal">null</span> ? p.left : p.right);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (replacement != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="comment">// 1. 有一个节点</span></span><br><span class="line">		<span class="comment">// Link replacement to parent</span></span><br><span class="line">		<span class="comment">// 将replacement替换给节点p，替换之后，我们就少了一个节点，如果的节点p是黑色，我们需要做些调整。</span></span><br><span class="line">		replacement.parent = p.parent;</span><br><span class="line">		<span class="keyword">if</span> (p.parent == <span class="literal">null</span>)</span><br><span class="line">			root = replacement;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (p == p.parent.left)</span><br><span class="line">			p.parent.left = replacement;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			p.parent.right = replacement;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Null out links so they are OK to use by fixAfterDeletion.</span></span><br><span class="line">		p.left = p.right = p.parent = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Fix replacement</span></span><br><span class="line">		<span class="keyword">if</span> (p.color == BLACK)</span><br><span class="line">			fixAfterDeletion(replacement);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.parent == <span class="literal">null</span>) &#123; <span class="comment">// return if we are the only node.</span></span><br><span class="line">		<span class="comment">// 2. 此节点为ROOT</span></span><br><span class="line">		root = <span class="literal">null</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">// No children. Use self as phantom replacement and unlink.</span></span><br><span class="line">		<span class="comment">// 3. 没有子节点</span></span><br><span class="line">		<span class="comment">// 节点p是的黑色的话，需要做调整，然后才能把节点p移除。</span></span><br><span class="line">		<span class="keyword">if</span> (p.color == BLACK)</span><br><span class="line">			fixAfterDeletion(p);</span><br><span class="line">		<span class="comment">// 解除掉节点p</span></span><br><span class="line">		<span class="keyword">if</span> (p.parent != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (p == p.parent.left)</span><br><span class="line">				p.parent.left = <span class="literal">null</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (p == p.parent.right)</span><br><span class="line">				p.parent.right = <span class="literal">null</span>;</span><br><span class="line">			p.parent = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fixAfterDeletion代码解读注释如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** From CLR</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *  x 节点需要调整，x节点的路径少了个黑色节点，需要平衡。</span></span><br><span class="line"><span class="comment"> *  	1. x下面的有一个黑色节点删除。</span></span><br><span class="line"><span class="comment"> *  	2. x会被删除，x是黑色。</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> *  */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fixAfterDeletion</span><span class="params">(Entry&lt;K, V&gt; x)</span> &#123;</span><br><span class="line">	<span class="keyword">while</span> (x != root &amp;&amp; colorOf(x) == BLACK) &#123;</span><br><span class="line">		<span class="keyword">if</span> (x == leftOf(parentOf(x))) &#123;</span><br><span class="line">			Entry&lt;K, V&gt; sib = rightOf(parentOf(x));</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (colorOf(sib) == RED) &#123;</span><br><span class="line">				<span class="comment">// 情形2</span></span><br><span class="line">				setColor(sib, BLACK);</span><br><span class="line">				setColor(parentOf(x), RED);</span><br><span class="line">				rotateLeft(parentOf(x));</span><br><span class="line">				sib = rightOf(parentOf(x));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 到此为止，sib变为黑色</span></span><br><span class="line">			<span class="keyword">if</span> (colorOf(leftOf(sib)) == BLACK &amp;&amp; colorOf(rightOf(sib)) == BLACK) &#123;</span><br><span class="line">				<span class="comment">// 情形3</span></span><br><span class="line">				setColor(sib, RED);</span><br><span class="line">				x = parentOf(x);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (colorOf(rightOf(sib)) == BLACK) &#123;</span><br><span class="line">					<span class="comment">// 情形5</span></span><br><span class="line">					setColor(leftOf(sib), BLACK);</span><br><span class="line">					setColor(sib, RED);</span><br><span class="line">					rotateRight(sib);</span><br><span class="line">					sib = rightOf(parentOf(x));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// 情形6</span></span><br><span class="line">				setColor(sib, colorOf(parentOf(x)));</span><br><span class="line">				setColor(parentOf(x), BLACK);</span><br><span class="line">				setColor(rightOf(sib), BLACK);</span><br><span class="line">				rotateLeft(parentOf(x));</span><br><span class="line">				x = root;  <span class="comment">// 可以终止算法，说明这种情形是我们最终的想要的。</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123; <span class="comment">// symmetric</span></span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	setColor(x, BLACK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/08/05/jdk-src-treemap/" data-id="cm3sqo3lp001bh4602j45f1vj" data-title="jdk-src-treemap" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/src/" rel="tag">src</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-some-new-thoughts-about-career-development" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/23/some-new-thoughts-about-career-development/" class="article-date">
  <time class="dt-published" datetime="2019-07-22T16:27:00.000Z" itemprop="datePublished">2019-07-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/23/some-new-thoughts-about-career-development/">some-new-thoughts-about-career-development</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="职业发展的一些新思考"><a href="#职业发展的一些新思考" class="headerlink" title="职业发展的一些新思考"></a>职业发展的一些新思考</h1><ol>
<li>所有的事情应该是目标导向的，定的目标一定要全力完成，完不成时是不应该有借口的。</li>
<li>对于程序员或工程师而言，我们应该是介入一些非技术领域的内容，比如所在业务的行业知识等。这样会使我们能更清晰地去体会到实现目标的路径。否则一次目标的实现无法给我们带来做事的经验。</li>
<li>我们其实很清晰的看到不同层次的人做事风格是很不一样的。其实仔细地往深了想，应该是由于这些不同的做事风格导致了人在不同的阶层。</li>
<li>所有的事情能否完成最终都会落到成事的能力上，证明成事的能力：一是不停的完成目标；二是在专业领域展现出高水平的能力。</li>
<li>公司不是一个让人积极向上，让人进步的地方，能改变成积极向上的只有自己。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/23/some-new-thoughts-about-career-development/" data-id="cm3sqo3lr001uh4603yzt2im2" data-title="some-new-thoughts-about-career-development" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/life/" rel="tag">life</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-kafka-security-saslscram-acl" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/02/24/kafka-security-saslscram-acl/" class="article-date">
  <time class="dt-published" datetime="2019-02-24T07:25:06.000Z" itemprop="datePublished">2019-02-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/02/24/kafka-security-saslscram-acl/">kafka-security-saslscram-acl</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h1><p>kafka安全主题的内容主要是分为认证和权限。</p>
<p>认证为了证明你是alice，而权限是决定了你能做什么事情，比如能不能些topic，能不能读topic等之类的事情。</p>
<p>在 <a target="_blank" rel="noopener" href="http://kafka.apache.org/documentation/#security">http://kafka.apache.org/documentation/#security</a> 里介绍了好多种类型。如果我们想要在线上开启认证和权限，我们需要考虑好多东西。比如能否动态增加权限，客户端接入操作是否足够简单等等。基于各种讨论后，我们目前决定使用sasl&#x2F;scram + acl的方式。</p>
<p>此文章主要分为两块：一个是配置，另一个是操作命令。</p>
<h1 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h1><h2 id="2-1-说明"><a href="#2-1-说明" class="headerlink" title="2.1 说明"></a>2.1 说明</h2><p>在broker和zookeeper之间的认证不支持org.apache.kafka.common.security.scram.ScramLoginModule，所以引入org.apache.zookeeper.server.auth.DigestLoginModule。详见如下链接：</p>
<p><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Client-Server+mutual+authentication">https://cwiki.apache.org/confluence/display/ZOOKEEPER/Client-Server+mutual+authentication</a></p>
<p>如果不配置的话也可以，但是会在日志限制No JAAS Configure ‘Client’</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2019-02-24 16:03:15,121] WARN SASL configuration failed: javax.security.auth.login.LoginException: No JAAS configuration section named &#x27;Client&#x27; was found in specified JAAS configuration file: &#x27;/Users/liubinbin/Documents/install/kafka_2.12-2.1.0/config/kafka_server_jaas.conf&#x27;. Will continue connection to Zookeeper server without SASL authentication, if Zookeeper server allows it. (org.apache.zookeeper.ClientCnxn)</span><br></pre></td></tr></table></figure>

<p>如果配置之后启动broker会在日志里显示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[2019-02-24 14:06:09,599] INFO Client successfully logged <span class="keyword">in</span>. (org.apache.zookeeper.Login)</span><br><span class="line">[2019-02-24 14:06:09,600] INFO Client will use DIGEST-MD5 as SASL mechanism. (org.apache.zookeeper.client.ZooKeeperSaslClient)</span><br><span class="line">[2019-02-24 14:06:09,657] INFO Opening socket connection to server localhost/0:0:0:0:0:0:0:1:2181. Will attempt to SASL-authenticate using Login Context section <span class="string">&#x27;Client&#x27;</span> (org.apache.zookeeper.ClientCnxn)</span><br><span class="line">[2019-02-24 14:06:09,676] INFO Socket connection established to localhost/0:0:0:0:0:0:0:1:2181, initiating session (org.apache.zookeeper.ClientCnxn)</span><br><span class="line">[2019-02-24 14:06:09,795] INFO Session establishment complete on server localhost/0:0:0:0:0:0:0:1:2181, sessionid = 0x100043c21d70000, negotiated <span class="built_in">timeout</span> = 6000 (org.apache.zookeeper.ClientCnxn)</span><br><span class="line">[2019-02-24 14:06:09,799] INFO [ZooKeeperClient] Connected. (kafka.zookeeper.ZooKeeperClient)</span><br></pre></td></tr></table></figure>

<h2 id="2-2-broker"><a href="#2-2-broker" class="headerlink" title="2.2 broker"></a>2.2 broker</h2><h4 id="2-2-1-server-properties"><a href="#2-2-1-server-properties" class="headerlink" title="2.2.1 server.properties"></a>2.2.1 server.properties</h4><p>listeners&#x3D;SASL_PLAINTEXT:&#x2F;&#x2F;bin:9092</p>
<p>########### SASL&#x2F;SCRAM ############################<br>security.inter.broker.protocol&#x3D;SASL_PLAINTEXT<br>sasl.mechanism.inter.broker.protocol&#x3D;SCRAM-SHA-256<br>sasl.enabled.mechanisms&#x3D;SCRAM-SHA-256</p>
<p>########### ACL ############################<br>authorizer.class.name&#x3D;kafka.security.auth.SimpleAclAuthorizer<br>allow.everyone.if.no.acl.found&#x3D;true<br>super.users&#x3D;User:Admin</p>
<p>######################### ZK ############################<br>zookeeper.set.acl&#x3D;true</p>
<p>######################### ZK ############################<br>auto.create.topics.enable&#x3D;false</p>
<h4 id="2-2-2-kafka-server-jaas-conf"><a href="#2-2-2-kafka-server-jaas-conf" class="headerlink" title="2.2.2 kafka_server_jaas.conf"></a>2.2.2 kafka_server_jaas.conf</h4><p>新增jaas文件，内容如下：</p>
<p>KafkaServer {<br>    org.apache.kafka.common.security.scram.ScramLoginModule required<br>    username&#x3D;”admin”<br>    password&#x3D;”admin-secret”;<br>};</p>
<p>Client {<br>    org.apache.zookeeper.server.auth.DigestLoginModule required<br>    username&#x3D;”admin”<br>    password&#x3D;”admin-secret”;<br>};</p>
<p>此配置通过在kafka-server-start.sh中添加如下命令，将jaas文件加入broker的jvm中。</p>
<p>export KAFKA_OPTS&#x3D;”-Djava.security.auth.login.config&#x3D;$KAFKA_HOME&#x2F;config&#x2F;kafka_server_jaas.conf”</p>
<h2 id="2-3-zookeeper"><a href="#2-3-zookeeper" class="headerlink" title="2.3 zookeeper"></a>2.3 zookeeper</h2><h4 id="2-3-1-kafka-zk-jaas-conf"><a href="#2-3-1-kafka-zk-jaas-conf" class="headerlink" title="2.3.1 kafka_zk_jaas.conf"></a>2.3.1 kafka_zk_jaas.conf</h4><p>新增jaas文件，内容如下：</p>
<p>Server {<br>    org.apache.zookeeper.server.auth.DigestLoginModule required<br>    user_admin&#x3D;”admin-secret”;<br>};</p>
<p>需要和kafka_server_jaas.conf里Client对应。</p>
<p>此配置通过在zookeeper-server-start.sh中添加如下命令，将jaas文件加入zk的jvm中。</p>
<p>export KAFKA_OPTS&#x3D;”-Djava.security.auth.login.config&#x3D;$KAFKA_HOME&#x2F;config&#x2F;kafka_zk_jaas.conf”</p>
<h3 id="2-3-2-zoo-cfg"><a href="#2-3-2-zoo-cfg" class="headerlink" title="2.3.2 zoo.cfg"></a>2.3.2 zoo.cfg</h3><p>添加如下配置：</p>
<p>authProvider.1&#x3D;org.apache.zookeeper.server.auth.SASLAuthenticationProvider</p>
<p>requireClientAuthScheme&#x3D;sasl</p>
<h2 id="2-4-client"><a href="#2-4-client" class="headerlink" title="2.4 client"></a>2.4 client</h2><h3 id="2-4-1-kafka-client-jaas-conf"><a href="#2-4-1-kafka-client-jaas-conf" class="headerlink" title="2.4.1 kafka_client_jaas.conf"></a>2.4.1 kafka_client_jaas.conf</h3><p>新增jaas文件，内容如下：</p>
<p>KafkaClient {<br>    org.apache.kafka.common.security.scram.ScramLoginModule required<br>    username&#x3D;”alice”<br>    password&#x3D;”alice-secret”;<br>};</p>
<p>此配置通过在kafka-console-consumer.sh和kafka-console-producer.sh中添加如下命令，将jaas文件加入zk的jvm中。</p>
<p>export KAFKA_OPTS&#x3D;”-Djava.security.auth.login.config&#x3D;&#x2F;Users&#x2F;liubinbin&#x2F;Documents&#x2F;install&#x2F;kafka_2.12-2.1.0&#x2F;config&#x2F;kafka_client_jaas.conf”</p>
<h3 id="2-4-2-saslscram-producer-properties"><a href="#2-4-2-saslscram-producer-properties" class="headerlink" title="2.4.2 saslscram-producer.properties"></a>2.4.2 saslscram-producer.properties</h3><p>添加如下配置：</p>
<p>security.protocol&#x3D;SASL_PLAINTEXT<br>sasl.mechanism&#x3D;SCRAM-SHA-256</p>
<h3 id="2-4-3-saslscram-consumer-properties"><a href="#2-4-3-saslscram-consumer-properties" class="headerlink" title="2.4.3 saslscram-consumer.properties"></a>2.4.3 saslscram-consumer.properties</h3><p>添加如下配置：</p>
<p>security.protocol&#x3D;SASL_PLAINTEXT<br>sasl.mechanism&#x3D;SCRAM-SHA-256</p>
<h1 id="3-命令"><a href="#3-命令" class="headerlink" title="3. 命令"></a>3. 命令</h1><h2 id="3-1-认证"><a href="#3-1-认证" class="headerlink" title="3.1 认证"></a>3.1 认证</h2><h3 id="3-1-1-添加用户"><a href="#3-1-1-添加用户" class="headerlink" title="3.1.1 添加用户"></a>3.1.1 添加用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-configs.sh --zookeeper localhost:2181 --alter --add-config &#x27;SCRAM-SHA-256=[iterations=8192,password=alice-secret],SCRAM-SHA-512=[password=alice-secret]&#x27; --entity-type users --entity-name alice</span><br><span class="line">bin/kafka-configs.sh --zookeeper localhost:2181 --alter --add-config &#x27;SCRAM-SHA-256=[password=admin-secret],SCRAM-SHA-512=[password=admin-secret]&#x27; --entity-type users --entity-name admin</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-列出用户"><a href="#3-1-2-列出用户" class="headerlink" title="3.1.2 列出用户"></a>3.1.2 列出用户</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-configs.sh --zookeeper localhost:2181 --describe --entity-type users</span><br></pre></td></tr></table></figure>

<h3 id="3-1-3-查看用户"><a href="#3-1-3-查看用户" class="headerlink" title="3.1.3 查看用户"></a>3.1.3 查看用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-configs.sh --zookeeper localhost:2181 --describe --entity-type users --entity-name alice</span><br></pre></td></tr></table></figure>

<h3 id="3-1-4-删除用户"><a href="#3-1-4-删除用户" class="headerlink" title="3.1.4 删除用户"></a>3.1.4 删除用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-configs.sh --zookeeper localhost:2181 --alter --delete-config &#x27;SCRAM-SHA-512&#x27; --entity-type users --entity-name alice</span><br></pre></td></tr></table></figure>

<h2 id="3-2-权限"><a href="#3-2-权限" class="headerlink" title="3.2 权限"></a>3.2 权限</h2><h3 id="3-2-1-增加权限"><a href="#3-2-1-增加权限" class="headerlink" title="3.2.1 增加权限"></a>3.2.1 增加权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 --add --allow-principal User:alice --operation Write --topic liubb</span><br><span class="line">bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 --add --allow-principal User:alice --operation Read --topic liubb --group test-consumer-group</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-列出权限"><a href="#3-2-2-列出权限" class="headerlink" title="3.2.2 列出权限"></a>3.2.2 列出权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 --list --topic liubb</span><br></pre></td></tr></table></figure>

<h3 id="3-2-3-删除权限"><a href="#3-2-3-删除权限" class="headerlink" title="3.2.3 删除权限"></a>3.2.3 删除权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 --remove --allow-principal User:alice --operation Read --operation Write --topic liubb</span><br></pre></td></tr></table></figure>

<h2 id="3-3-客户端"><a href="#3-3-客户端" class="headerlink" title="3.3 客户端"></a>3.3 客户端</h2><p>ps：localhost 在虚拟机内可能需要换成 hostname</p>
<h3 id="3-3-1-生产者"><a href="#3-3-1-生产者" class="headerlink" title="3.3.1 生产者"></a>3.3.1 生产者</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092  --topic liubb --producer.config config/saslscram-producer.properties</span><br></pre></td></tr></table></figure>

<h3 id="3-3-2-消费者"><a href="#3-3-2-消费者" class="headerlink" title="3.3.2 消费者"></a>3.3.2 消费者</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --from-beginning --topic liubb --consumer.config config/saslscram-consumer.properties</span><br></pre></td></tr></table></figure>
















      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/02/24/kafka-security-saslscram-acl/" data-id="cm3sqo3lq001fh460hul24jom" data-title="kafka-security-saslscram-acl" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-kafka-series" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/02/24/kafka-series/" class="article-date">
  <time class="dt-published" datetime="2019-02-24T07:23:38.000Z" itemprop="datePublished">2019-02-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/02/24/kafka-series/">kafka-series</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在接下里的一段时间，我会重点打理这个kafka系列。</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://liubinbin.cn/2019/02/24/kafka-security-saslscram-acl/">security</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/02/24/kafka-series/" data-id="cm3sqo3lq001ih460con69eo7" data-title="kafka-series" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-hbase-src-series" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/12/30/hbase-src-series/" class="article-date">
  <time class="dt-published" datetime="2018-12-30T15:47:20.000Z" itemprop="datePublished">2018-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/12/30/hbase-src-series/">HBase源码系列</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在2018年即将结束之际，想开一个系列，名字为HBase源码系列。</p>
<p>先说一下对HBase的感觉，首先，一个很重要的原因，我本人对数据非常感兴趣。其次，个人觉得HBase是个非常重要的项目，在接下来的几年也会保持下去。最后，HBase是个可以学习的不错项目，里面很多的设计和特性值得学习，并且我有使用和维护经验。</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://liubinbin.cn/2018/12/30/hbase-src-wal/">wal</a></li>
<li><a target="_blank" rel="noopener" href="http://liubinbin.cn/2017/05/14/hbase-src-hfile/">hfile</a></li>
<li><a target="_blank" rel="noopener" href="http://liubinbin.cn/2017/05/09/hbase-src-compaction/">compaction</a></li>
<li><a target="_blank" rel="noopener" href="http://liubinbin.cn/2017/04/25/hbase-src-get-in-server/">get</a></li>
<li><a target="_blank" rel="noopener" href="http://liubinbin.cn/2017/04/12/hbase-src-memstore/">memstore</a></li>
<li><a target="_blank" rel="noopener" href="http://liubinbin.cn/2017/04/09/hbase-src-mvcc/">mvcc</a></li>
<li>To be continued</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/12/30/hbase-src-series/" data-id="cm3sqo3ln000mh4605trk21jx" data-title="HBase源码系列" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hbase/" rel="tag">hbase</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-hbase-src-wal" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/12/30/hbase-src-wal/" class="article-date">
  <time class="dt-published" datetime="2018-12-30T15:45:33.000Z" itemprop="datePublished">2018-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/12/30/hbase-src-wal/">HBase源码系列之wal</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>wal在hbase中是为了持久化memstore中未flush到hfile的数据，以防rs宕机或异常退出导致数据的丢失。</p>
<p>wal实现的一头是多个handler线程处理put请求，另一头是针对hdfs写这种费时间的操作。并且需要实现两件事情：一是在写hdfs时不能出现混乱，二是写完hdfs之后需要有个机制通知到在等待hdfs写返回的处理写请求的线程。</p>
<p>wal用了一个ringbuffer，ringbuffer传递内容包括的sync标志（主要用于传递SyncFuture）和数据。分开可以用于控制。</p>
<h1 id="主流程"><a href="#主流程" class="headerlink" title="主流程"></a>主流程</h1><ol>
<li>handler将entry和txid写入disruptor，然后通过sync函数等待，通过一个threadlocal的设置了txid的SyncFuture，调用get方法阻塞。</li>
<li>把SyncFuture和Sync标志写入到disruptor中。</li>
<li>在disruptor的Handler的onEvent里：<ol>
<li>将entry给append到writer里。</li>
<li>设置SyncFuture，用于传递。</li>
</ol>
</li>
<li>给syncRunners传递带txid的SyncFuture</li>
<li>SyncRunner会在while里不停的跑，<ol>
<li>releaseSyncFuture已经sync过的数据（可能在别的syncRunner）</li>
<li>sync数据，然后releaseSyncFuture</li>
</ol>
</li>
</ol>
<h1 id="三个主要线程"><a href="#三个主要线程" class="headerlink" title="三个主要线程"></a>三个主要线程</h1><p>整个写wal流程涉及到如下三个线程。</p>
<h2 id="handler线程"><a href="#handler线程" class="headerlink" title="handler线程"></a>handler线程</h2><p>handler通过netty接受来自客户端或thriftserver的写请求。</p>
<p>在private void doMiniBatchMutate(BatchOperation&lt;?&gt; batchOp) throws IOException 总在执行写wal，写memstore，更改mvcc版本等操作。本篇文章主要集中于写wal（否则就跑题了）,主要在如下方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">writeEntry = doWALAppend(walEdit, batchOp.durability, batchOp.getClusterIds(), now,</span><br><span class="line">             nonceKey.getNonceGroup(), nonceKey.getNonce(), batchOp.getOrigLogSeqNum());</span><br></pre></td></tr></table></figure>

<p>doWALAppend方法里主要内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">txid</span> <span class="operator">=</span> <span class="built_in">this</span>.wal.append(<span class="built_in">this</span>.getRegionInfo(), walKey, walEdit, <span class="literal">true</span>);</span><br><span class="line">   <span class="comment">// Call sync on our edit.</span></span><br><span class="line">   <span class="keyword">if</span> (txid != <span class="number">0</span>) &#123;</span><br><span class="line">     sync(txid, durability);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>append主要把数据加入到ringbuffer中，sync方法具体如下：</p>
<ol>
<li>讲ThreadLocal<SyncFuture> cachedSyncFutures然后扔到ringbuffer里，然后讲syncFuture返回。</li>
<li>执行syncFuture.get(walSyncTimeoutNs)阻塞。</li>
</ol>
<p>handler线程会卡在syncFuture.get(walSyncTimeoutNs)处。get具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeoutNs)</span> <span class="keyword">throws</span> InterruptedException,</span><br><span class="line">      ExecutionException, TimeoutIOException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">done</span> <span class="operator">=</span> System.nanoTime() + timeoutNs;</span><br><span class="line">    <span class="keyword">while</span> (!isDone()) &#123;</span><br><span class="line">      wait(<span class="number">1000</span>);</span><br><span class="line">      <span class="keyword">if</span> (System.nanoTime() &gt;= done) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TimeoutIOException</span>(</span><br><span class="line">            <span class="string">&quot;Failed to get sync result after &quot;</span> + TimeUnit.NANOSECONDS.toMillis(timeoutNs)</span><br><span class="line">                + <span class="string">&quot; ms for txid=&quot;</span> + <span class="built_in">this</span>.txid + <span class="string">&quot;, WAL system stuck?&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.throwable != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutionException</span>(<span class="built_in">this</span>.throwable);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.doneTxid;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看到handler线程如果想要退出需要isDone方法返回false或者时间超过timeoutNs。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">isDone</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.doneTxid != NOT_DONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handler线程部分到此我们只需要记住doneTxid的修改决定handler线程退出。</p>
<h2 id="onEvent"><a href="#onEvent" class="headerlink" title="onEvent"></a>onEvent</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (truck.type() == RingBufferTruck.Type.SYNC) &#123;</span><br><span class="line">        <span class="comment">// 给syncFutures其中一个设置。</span></span><br><span class="line">        <span class="built_in">this</span>.syncFutures[<span class="built_in">this</span>.syncFuturesCount.getAndIncrement()] = truck.unloadSync();</span><br><span class="line">        <span class="comment">// Force flush of syncs if we are carrying a full complement of syncFutures.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.syncFuturesCount.get() == <span class="built_in">this</span>.syncFutures.length) &#123;</span><br><span class="line">          endOfBatch = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (truck.type() == RingBufferTruck.Type.APPEND) &#123;</span><br><span class="line">        <span class="type">FSWALEntry</span> <span class="variable">entry</span> <span class="operator">=</span> truck.unloadAppend();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">	...</span><br><span class="line">          append(entry);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          ....</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>在onEvent里获取到的数据分为两种：</p>
<ol>
<li>SYNC，在syncFutures设置handler线程传递过来的syncFuture。</li>
<li>APPEND，调用append。在这里我们可以看到ringbuffer的作用就是把多个线程的写入按时间顺序的append。</li>
</ol>
<p>我们需要注意这里的endOfBatch，通过一个ringbuffer其实让我们更容易去控制batch，将难度从多个线程移到了一个线程里。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!endOfBatch || <span class="built_in">this</span>.syncFuturesCount.get() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.syncRunnerIndex = (<span class="built_in">this</span>.syncRunnerIndex + <span class="number">1</span>) % <span class="built_in">this</span>.syncRunners.length;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 给syncRunners其中一个设置，在offer方法内，将下标小于syncFuturesCount的所有syncFutures传递给其中一个的SyncRunners。</span></span><br><span class="line">        <span class="comment">// 下标小于syncFuturesCount的所有syncFutures都传递过去其实就代表了一个batch，这个逻辑可以通过endOfBatch捋出来。 *** 此处很重要 ***</span></span><br><span class="line">        <span class="built_in">this</span>.syncRunners[<span class="built_in">this</span>.syncRunnerIndex].offer(sequence, <span class="built_in">this</span>.syncFutures,</span><br><span class="line">          <span class="built_in">this</span>.syncFuturesCount.get());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// Should NEVER get here.</span></span><br><span class="line">        requestLogRoll();</span><br><span class="line">        <span class="built_in">this</span>.exception = <span class="keyword">new</span> <span class="title class_">DamagedWALException</span>(<span class="string">&quot;Failed offering sync&quot;</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">....</span><br><span class="line">      <span class="built_in">this</span>.syncFuturesCount.set(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>这里通过轮询的方式向syncRunners传递syncFutures。</p>
<h2 id="syncRunner"><a href="#syncRunner" class="headerlink" title="syncRunner"></a>syncRunner</h2><p>syncRunner是一些线程，总共syncRunnerCount个，此线程是一个while不停的执行。多个线程通过highestSyncedTxid来沟通到什么地步了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">     <span class="type">int</span> <span class="variable">syncCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">// 获取需要执行sync的场景</span></span><br><span class="line">       <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">         takeSyncFuture = <span class="literal">null</span>;</span><br><span class="line">         <span class="comment">// We have to process what we &#x27;take&#x27; from the queue</span></span><br><span class="line">         takeSyncFuture = <span class="built_in">this</span>.syncFutures.take();</span><br><span class="line">         currentSequence = <span class="built_in">this</span>.sequence;</span><br><span class="line">         <span class="type">long</span> <span class="variable">syncFutureSequence</span> <span class="operator">=</span> takeSyncFuture.getTxid();</span><br><span class="line">         <span class="keyword">if</span> (syncFutureSequence &gt; currentSequence) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;currentSequence=&quot;</span> + currentSequence</span><br><span class="line">               + <span class="string">&quot;, syncFutureSequence=&quot;</span> + syncFutureSequence);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// See if we can process any syncfutures BEFORE we go sync.</span></span><br><span class="line">         <span class="comment">// 掠过一些已经sync过的sequence，可能在别syncRunner已经执行过了，或当时多加的部分。</span></span><br><span class="line">         <span class="type">long</span> <span class="variable">currentHighestSyncedSequence</span> <span class="operator">=</span> highestSyncedTxid.get();</span><br><span class="line">         <span class="keyword">if</span> (currentSequence &lt; currentHighestSyncedSequence) &#123;</span><br><span class="line">           syncCount += releaseSyncFuture(takeSyncFuture, currentHighestSyncedSequence, <span class="literal">null</span>);</span><br><span class="line">           <span class="comment">// Done with the &#x27;take&#x27;. Go around again and do a new &#x27;take&#x27;.</span></span><br><span class="line">           <span class="keyword">continue</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// 执行sync</span></span><br><span class="line">         writer.sync(useHsync);</span><br><span class="line">         <span class="comment">// 更新highestSyncedTxid，此处记录了目前sync的最高Sequence。</span></span><br><span class="line">         currentSequence = updateHighestSyncedSequence(currentSequence);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">...</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="comment">// First release what we &#x27;took&#x27; from the queue.</span></span><br><span class="line">         <span class="comment">// release目前取到的SyncFuture。</span></span><br><span class="line">         syncCount += releaseSyncFuture(takeSyncFuture, currentSequence, lastException);</span><br><span class="line">         <span class="comment">// Can we release other syncs?</span></span><br><span class="line">         <span class="comment">// release所有目前小于当前sequence的SyncFuture。这步感觉好像是没有必要的。</span></span><br><span class="line">         syncCount += releaseSyncFutures(currentSequence, lastException);</span><br><span class="line">         <span class="keyword">if</span> (lastException != <span class="literal">null</span>) &#123;</span><br><span class="line">           requestLogRoll();</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           checkLogRoll();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       postSync(System.nanoTime() - start, syncCount);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">       ...</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>调用完releaseSyncFuture之后，handler阻塞住的的get方式才能顺利进行下去。</p>
<p>此处需要一张图</p>
<p><img src="/hbase-wal.png"></p>
<p>思考：syncRunner为多个，大概是为了隔离notifier和sync，两种操作不要在一起，最终可以减轻同步代价。</p>
<h2 id="简单版代码实现"><a href="#简单版代码实现" class="headerlink" title="简单版代码实现"></a>简单版代码实现</h2><p>见地址 <a target="_blank" rel="noopener" href="https://github.com/liubinbin/pan/tree/master/src/main/java/cn/liubinbin/pan/experiment/log/v3">https://github.com/liubinbin/pan/tree/master/src/main/java/cn/liubinbin/pan/experiment/log/v3</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/12/30/hbase-src-wal/" data-id="cm3sqo3lo000rh4601s0p6n8d" data-title="HBase源码系列之wal" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hbase/" rel="tag">hbase</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ability/" rel="tag">ability</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bank/" rel="tag">bank</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/career/" rel="tag">career</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/concurrent/" rel="tag">concurrent</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/" rel="tag">flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gc/" rel="tag">gc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/" rel="tag">hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hbase/" rel="tag">hbase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hdfs/" rel="tag">hdfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/invest/" rel="tag">invest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/job/" rel="tag">job</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/life-reading/" rel="tag">life,reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvn/" rel="tag">mvn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paldb/" rel="tag">paldb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paper/" rel="tag">paper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rcfile/" rel="tag">rcfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reading/" rel="tag">reading</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/src/" rel="tag">src</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/summary/" rel="tag">summary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/writing/" rel="tag">writing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zk/" rel="tag">zk</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ability/" style="font-size: 10px;">ability</a> <a href="/tags/bank/" style="font-size: 10px;">bank</a> <a href="/tags/career/" style="font-size: 12px;">career</a> <a href="/tags/concurrent/" style="font-size: 10px;">concurrent</a> <a href="/tags/flume/" style="font-size: 10px;">flume</a> <a href="/tags/gc/" style="font-size: 10px;">gc</a> <a href="/tags/hadoop/" style="font-size: 12px;">hadoop</a> <a href="/tags/hbase/" style="font-size: 18px;">hbase</a> <a href="/tags/hdfs/" style="font-size: 14px;">hdfs</a> <a href="/tags/invest/" style="font-size: 10px;">invest</a> <a href="/tags/java/" style="font-size: 12px;">java</a> <a href="/tags/job/" style="font-size: 10px;">job</a> <a href="/tags/kafka/" style="font-size: 12px;">kafka</a> <a href="/tags/life/" style="font-size: 20px;">life</a> <a href="/tags/life-reading/" style="font-size: 10px;">life,reading</a> <a href="/tags/mvn/" style="font-size: 10px;">mvn</a> <a href="/tags/paldb/" style="font-size: 10px;">paldb</a> <a href="/tags/paper/" style="font-size: 10px;">paper</a> <a href="/tags/rcfile/" style="font-size: 10px;">rcfile</a> <a href="/tags/reading/" style="font-size: 16px;">reading</a> <a href="/tags/spring/" style="font-size: 10px;">spring</a> <a href="/tags/src/" style="font-size: 12px;">src</a> <a href="/tags/summary/" style="font-size: 10px;">summary</a> <a href="/tags/writing/" style="font-size: 10px;">writing</a> <a href="/tags/zk/" style="font-size: 10px;">zk</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">June 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/11/22/%E4%B8%89%E4%B8%AA%E6%8A%95%E8%B5%84%E6%96%B9%E5%90%91/">三个投资方向</a>
          </li>
        
          <li>
            <a href="/2024/10/10/%E8%82%A1%E7%A5%A8%E6%98%AF%E4%B8%8E%E4%BA%BA%E3%80%81%E4%B8%8E%E6%97%B6%E9%97%B4%E7%9A%84%E6%B8%B8%E6%88%8F/">股票是与人、与时间的游戏</a>
          </li>
        
          <li>
            <a href="/2024/08/15/%E4%BB%8E%E5%90%8E%E6%82%94%E4%B8%AD%E5%AD%A6%E5%88%B0%E4%B8%9C%E8%A5%BF/">从后悔中学到东西</a>
          </li>
        
          <li>
            <a href="/2024/08/13/%E5%90%91%E6%89%80%E6%9C%89%E4%BA%BA%E5%AD%A6%E4%B9%A0/">向所有人学习</a>
          </li>
        
          <li>
            <a href="/2024/08/06/%E3%80%8A%E5%A4%A7%E5%86%B3%E6%88%98%E4%B9%8B%E8%BE%BD%E6%B2%88%E6%88%98%E5%BD%B9%E3%80%8B%E8%A7%82%E5%90%8E%E6%84%9F/">《大决战之辽沈战役》观后感</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 binbin liu<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>